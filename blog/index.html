
<!DOCTYPE HTML>

<html>










<head>
	<meta charset="utf-8">
	<title>Hakan Tuncer's Blog</title>
	<meta name="author" content="Hakan Tuncer">
	<meta name="description" content="Follow @hakant Oct 19th, 2017 ContinuousDelivery,Azure,Angular,Docker,TravisCI Comments Continuous Deployment With Angular CLI, Docker, Travis CI &hellip;">
	
	<!-- http://t.co/dKP3o1e -->
  	<meta name="HandheldFriendly" content="True">
  	<meta name="MobileOptimized" content="320">
  	<meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="Hakan Tuncer's Blog" />
    <meta property="og:description" content="Follow @hakant Oct 19th, 2017 ContinuousDelivery,Azure,Angular,Docker,TravisCI Comments Continuous Deployment With Angular CLI, Docker, Travis CI &hellip;" />
    <meta property="og:url" content="http://www.hakantuncer.com/blog/" />
    <meta property="og:image" content="https://media.licdn.com/media/p/4/005/027/329/2633870.jpg" />
	
	<link href="/atom.xml" rel="alternate" title="Hakan Tuncer's Blog" type="application/atom+xml">	
	<link rel="canonical" href="http://www.hakantuncer.com/blog/">
	<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
	<link href="/favicon.ico" rel="icon" type="image/x-icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("hakantuncer@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
	
</div>
<hgroup>
  <h1><a href="/">Full Stack Developer focusing on .NET, JavaScript, Angular, Node.js and Azure</a></h1>
  
    <h2>“Whatever you can do, or dream you can, begin it. Boldness has genius, magic, and power in it. Begin it now.” ~ Goethe</h2>
  
</hgroup>

<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">home</a></li>
  <li><a href="/blog">blog</a></li>
  <li><a href="/blog/archives">archives</a></li>
</ul>

</nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:hakantuncer@gmail.com" title="Email">Email</a>
		
		
		
		
			<a class="twitter" href="http://twitter.com/hakant" target="_blank" title="Twitter">Twitter</a>
		
		
		
		
			<a class="linkedin" href="http://www.linkedin.com/in/hakantuncer" target="_blank" title="LinkedIn">LinkedIn</a>
		
		
		
		
		
		
			<a class="github" href="https://github.com/hakant" target="_blank" title="GitHub">GitHub</a>
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="twitter">
			<a href="https://twitter.com/hakant" class="twitter-follow-button" data-show-count="false">Follow @hakant</a>
		<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
		</div>
		<div class="date">








  


<time datetime="2017-10-19T09:39:36+02:00" data-updated="true" itemprop="datePublished">Oct 19<span>th</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/continuousdelivery-azure-angular-docker-travisci/'>ContinuousDelivery,Azure,Angular,Docker,TravisCI</a>


</div>
		
			<span class="comments"><a href="/blog/2017/10/19/continuous-deployment-with-angular-cli/#disqus_thread">Comments</a></span>
		

	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2017/10/19/continuous-deployment-with-angular-cli/" itemprop="url">Continuous Deployment With Angular CLI, Docker, Travis CI and Azure</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>These days when I start writing code for a new project, I feel a sense of urgency to create an end to end development workflow as soon as possible. I love the phrase “<a href="http://alistair.cockburn.us/Walking+skeleton">walking skeleton</a>”. So think of this end to end workflow as a walking skeleton of a <a href="https://en.wikipedia.org/wiki/Continuous_delivery">continuous delivery pipeline</a>. It’s basically taking a smallest possible version of your application and setting up the necessary infrastructure to be able to continuously build, run analysis, test and deploy to a production-like environment.</p>

<p>Please don’t confuse this idea with a waterfall concept. Your build, test and deployment scripts don’t have to be future proof. They don’t have to cover all the possible scenarios that you might need in the future. Far from it. The idea is to have (just) enough capability in the pipeline to be able to cover a (vertical) slice of your application. It should have enough “meat” to get you going.</p>

<p>Also note that the definition of “vertical” has grown larger with the <a href="https://en.wikipedia.org/wiki/DevOps">DevOps</a> way of doing things. You should probably not stop at automated deployments either. Can you also monitor this first small version of your application already — both in terms of usage and errors ? Do you already have a central place to track bugs, features and collaborate with other stakeholders? So yes, the idea is to really get your whole cycle up and running as soon as possible. But I digress..</p>

<h2>.travis.yml file</h2>

<p><a href="https://en.wikipedia.org/wiki/YAML">YAML</a> files have become a standard way of configuring continuous integration &amp; delivery pipelines. <a href="https://docs.travis-ci.com/user/customizing-the-build/">Travis CI is no different</a>.</p>

<p>YAML file below tells Travis to;</p>

<ul>
<li>(lines 4-5) Install node 7.7.4</li>
<li>(lines 7-8) Make docker available.</li>
<li>(lines 10-20) Install and configure the latest stable version of Chrome</li>
<li>(line 23) Download all javascript packages that the Angular app uses</li>
<li>(line 26) Run all Angular component tests and do not watch files, quit immediately after.</li>
<li>(line 27) Run all end to end protractor tests. Think of this like Selenium but a bit more specialised for Angular.</li>
</ul>


<br/>




<script src="https://gist.github.com/hakant/35b9259651d2b03b3d73cb92be0aaadb.js"></script>


<ul>
<li>(lines 29–30) If the build is successful and branch is master, prepare for packaging and deployment.</li>
<li>(line 31) Build the angular app using the CLI. This will transpile all .ts files and create .js bundles using <a href="https://webpack.github.io/">webpack</a>. It will eventually create a folder called “dist” which will include all the release artefacts that are ready for deployment.</li>
<li>(line 32) Build a docker image with the specified name and based on the specified docker file. You can see the <a href="https://github.com/hakant/Roost-Angular/blob/master/.docker/nginx.dockerfile">docker file</a> and the <a href="https://github.com/hakant/Roost-Angular/blob/master/.docker/nginx.conf">nginx configuration</a> if you’re interested.</li>
<li>(line 33) Tag the image that’s just been created using the SHA of the latest git commit. This way any docker file can be reverse engineered to it’s exact source version.</li>
<li>(lines 34-35) Login to docker hub and push the image (using secret environment variables which I’d set earlier on Travis). You can see a list of images that I’ve already pushed on <a href="https://hub.docker.com/r/hakant/roost-angular/tags/">docker hub</a>.</li>
</ul>


<p><a href="https://travis-ci.org/hakant/Roost-Angular/builds">At the time of this writing there were 20 builds in the history</a>.</p>

<p>So last step above pushes the brand new docker image to Docker Hub but how does it get deployed on Azure ?</p>

<h2>Continuous Deployment of Docker Images to Azure</h2>

<p>There’s one more step which is kinda invisible and that’s the deployment of the new docker image to an Azure Web App as a container. This is achieved through a <a href="https://docs.microsoft.com/en-us/azure/app-service/containers/app-service-linux-ci-cd">webhook that is setup behind the scenes in Docker Hub and Azure Portal</a>. There are a few commands that need to be executed against the Azure CLI:</p>

<p>Enabling container continuous deployment feature:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>az webapp deployment container config -n Roost-Angular -g Roost -e true</div></code></pre></td></tr></table></div></figure>


<p>Obtaining the WebHook URL:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>az webapp deployment container show-cd-url -n roost-angular -g roost</div></code></pre></td></tr></table></div></figure>


<p>Pasting the WebHook URL on Docker Hub:</p>

<p><img src="/assets/CD_Docker_Angular_Azure/DockerHub_WebHook.png" alt="Docker Hub WebHook" /></p>

<p>Once this is done, whenever a new image is pushed into Docker Hub, this webhook is automatically invoked. I’ve noticed that if I make a GET call to this URL manually, it also kicks off a new deployment. Straightforward.</p>

<p>And on Azure Portal there’s a designated “Docker Container” tab under the Azure Web App for this purpose. Notice the name of the image and the webhook url (which is concealed by default). One docker convention to keep in mind is that when a :tag is not specified it means :latest.</p>

<p><img src="/assets/CD_Docker_Angular_Azure/DockerContainer_Tab_Azure.png" alt="Docker Container Tab Azure" /></p>

<h2>More information</h2>

<br/>


<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/app-service/containers/quickstart-custom-docker-image">Run a custom Docker Hub image in Azure Web App for Containers</a></li>
<li><a href="https://docs.travis-ci.com/user/docker/">Travis CI — Using Docker in Builds</a></li>
<li><a href="https://docs.docker.com/docker-cloud/builds/push-images/">Push images to Docker Cloud</a></li>
<li><a href="https://github.com/angular/angular-cli/wiki/stories">Stories describing how to do more with the Angular CLI</a></li>
<li><a href="https://www.sitepoint.com/ultimate-angular-cli-reference/">The Ultimate Angular CLI Reference Guide</a></li>
<li><a href="https://github.com/angular/angular-cli/wiki/test">ng test</a>, <a href="https://github.com/angular/angular-cli/wiki/e2e">ng e2e</a>, <a href="https://github.com/angular/angular-cli/wiki/build">ng build</a></li>
</ul>


<p>Thanks for reading.</p>

<p>~Hakan</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="twitter">
			<a href="https://twitter.com/hakant" class="twitter-follow-button" data-show-count="false">Follow @hakant</a>
		<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
		</div>
		<div class="date">








  


<time datetime="2017-05-25T07:48:55+02:00" data-updated="true" itemprop="datePublished">May 25<span>th</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/aws/'>AWS</a>, <a class='category' href='/blog/categories/circleci/'>CircleCi</a>, <a class='category' href='/blog/categories/continuousdelivery/'>ContinuousDelivery</a>, <a class='category' href='/blog/categories/dynamodb/'>DynamoDb</a>, <a class='category' href='/blog/categories/nodejs/'>NodeJS</a>


</div>
		
			<span class="comments"><a href="/blog/2017/05/25/continuous-deployment-with-node-dot-js/#disqus_thread">Comments</a></span>
		

	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2017/05/25/continuous-deployment-with-node-dot-js/" itemprop="url">Continuous Deployment With Node.js, DynamoDB, AWS Elastic Beanstalk and CircleCI</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>These days everybody is talking about DevOps and CI pipelines. Unicorn tech companies are building DevOps tools and CI pipelines as a service and bragging about their user friendly design and how easy it is to setup these pipelines on their branded platforms. This is all nice and useful, however, I can’t help but see another <a href="https://www.youtube.com/watch?v=qamzvLfX-Zo">silver bullet syndrome</a>.</p>

<p>Anyone who’s building non-trivial software systems long enough know that software development is hard. Especially with sizeable teams that are larger than only a few devs, it’s very easy to turn the system into <a href="https://vimeo.com/171704597">a big ball of mud</a> and get the codebase into a state that is difficult to understand and to reliably test in an automated fashion.</p>

<p>If you don’t have reliable automated tests with realistic test cases and good coverage, your CI pipeline is just a lie. So please stop treating your CI pipelines (that probably took you 10 minutes to create these days) as silver bullets.</p>

<p>All that said, if you have actually done the REAL work and payed attention to your codebase, your architecture and treated your tests as highly as your production code, then you can now go ahead and create your CI pipeline in 10 minutes and it will benefit you tremendously.</p>

<p>This is a follow-up on my previous blog posts where I did the real work and made my codebase clean and testable. You can find them here in two parts: <a href="/blog/2017/02/17/setting-up-continuous-integration-and-delivery-for-a-nodejs-rest-api/">Part 1</a> and <a href="/blog/2017/03/25/setting-up-continuous-delivery-for-a-node-dot-js-rest-api-part-2/">Part 2</a>. Having said that, these are no pre-requisites to this post by any means. Just continue reading if you’re only interested in the Continuous Delivery Pipeline itself, you should be perfectly fine.</p>

<h2>Why CircleCI</h2>

<p>I know it won&rsquo;t sound very exciting but there’s actually no particular reason. My two biggest requirements were FREE and SaaS. I obviously don’t want to pay a monthly fee for the CI pipeline of an open source hobby project. And I just want to use it SaaS style and don’t want to own anything. To name a few alternatives to <a href="https://circleci.com/">CircleCI</a> which are free for non-commercial open source projects and SaaS; there is <a href="https://www.visualstudio.com/team-services/">VSTS</a>, <a href="https://www.appveyor.com">AppVeyor</a> and <a href="https://travis-ci.org">Travis CI</a>. I used the first two, they’re all very good offerings, I would also like to carve some time to try Travis in the future if I can.</p>

<h2>Configuring the Pipeline with CircleCI</h2>

<p>There’s an <a href="https://circleci.com/docs/1.0/configuration/">in depth documentation</a> that describes the ins and outs of CircleCI and how to configure your pipeline for various needs and scenarios. It starts with:</p>

<blockquote><p>CircleCI automatically infers settings from your code, so it’s possible you won’t need to add any custom configuration.
<br/><br/>
If you do need to tweak settings, you can create a circle.yml in your project’s root directory. If this file exists, CircleCI will read it each time it runs a build.</p></blockquote>

<p>The automatic inference of settings does not completely work for <a href="https://github.com/hakant/HackathonPlannerAPI">my codebase</a>. There are certain build steps that I want to override and specify my specific need — like transpiling TypeScript and running tests against a DynamoDB emulator, so I need to create a <strong>circle.yml</strong> file in the project root directory.</p>

<h2>Primary Steps of a CircleCI Pipeline</h2>

<p>When we talk about a CI pipeline, we’re actually talking about a series of steps that are executed one after the other in a deterministic and repeatable manner.</p>

<blockquote><p>The <strong>circle.yml</strong> file has seven primary sections. Each section represents a phase of the Build-Test-Deploy process:
<br/><br/>
<strong>machine</strong>: adjust the behavior of the virtual machine (VM)
<br/><br/>
<strong>checkout</strong>: checkout and clone code from a repository
<br/><br/>
<strong>dependencies</strong>: install your project’s language-specific dependencies
<br/><br/>
<strong>database</strong>: prepare a database for tests
<br/><br/>
<strong>compile</strong>: compile your project
<br/><br/>
<strong>test</strong>: run your tests
<br/><br/>
<strong>deployment</strong>: deploy your code to your web servers</p></blockquote>

<p>For each of these sections CircleCI automatically infers commands based on the characteristics of the codebase.</p>

<blockquote><p>You can specify when to run custom commands relative to CircleCI’s inferred commands using three special keys:
<br/><br/>
<strong>pre</strong>: run before inferred commands
<br/><br/>
<strong>override</strong>: run instead of inferred commands
<br/><br/>
<strong>post</strong>: run after inferred commands</p></blockquote>

<h2>CircleCI configuration of Hackathon Planner</h2>

<p>I want to create the CI pipeline for <a href="https://github.com/hakant/HackathonPlannerAPI">Hackathon Planner’s REST API</a>. This API is built with <a href="https://nodejs.org">Node.js</a>, <a href="http://expressjs.com">ExpressJS</a>, <a href="http://www.typescriptlang.org">TypeScript</a>, <a href="https://aws.amazon.com/dynamodb/">DynamoDB</a> and deployed to <a href="https://aws.amazon.com/elasticbeanstalk/">AWS Elastic Beanstalk</a>.</p>

<br/>


<h3>machine</h3>

<p>My REST API is running on node 5.11. So I want to use the same version of node to run my tests. </p>

<p>I also need Java Development Kit (jdk) to run the DynamoDB emulator. My Unit/Integration tests will run against this emulated DynamoDB instance.</p>

<p>After node and jdk is installed on the machine, I need to run 3 commands to download, extract and run DynamoDB emulator (under section “post”):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>machine:
</div><div class='line'>  node:
</div><div class='line'>    version: 5.11
</div><div class='line'>  java:
</div><div class='line'>    version: openjdk7
</div><div class='line'>  post:
</div><div class='line'>    - curl -k -L -o dynamodb-local.tgz http://dynamodb-local.s3-website-us-west-2.amazonaws.com/dynamodb_local_latest.tar.gz
</div><div class='line'>    - tar -xzf dynamodb-local.tgz
</div><div class='line'>    - &quot;java -Xms1024m -Xmx1024m -Djava.library.path=~/DynamoDBLocal_lib -jar ~/DynamoDBLocal.jar --port 8000&quot;: background: true</div></code></pre></td></tr></table></div></figure>




<br/>


<h3>compile</h3>

<p>In this part of the build step, I’m taking over the inferred behavior of CircleCI using the “override” keyword.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>compile:
</div><div class='line'>  override:
</div><div class='line'>    - tsc -p .</div></code></pre></td></tr></table></div></figure>


<p>“tsc” is the TypeScript compiler and the “-p” flag tells it to compile the project given a valid configuration file (tsconfig.json). In my codebase, this file is located in the root directory.</p>

<p>“tsconfig.json” file below tells the compiler to transpile all TypeScript files in the folder (recursively) except the contents of the “node_modules” folder. For more info on TypeScript compiler options, <a href="https://www.typescriptlang.org/docs/handbook/compiler-options.html">checkout this documentation</a>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
</pre></td><td class='code' width='100%'><pre><code class='json'><div class='line'><span class="p">{</span>
</div><div class='line'>    <span class="nt">&quot;compilerOptions&quot;</span><span class="p">:</span> <span class="p">{</span>
</div><div class='line'>        <span class="nt">&quot;module&quot;</span><span class="p">:</span> <span class="s2">&quot;commonjs&quot;</span><span class="p">,</span>
</div><div class='line'>        <span class="nt">&quot;sourceMap&quot;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</div><div class='line'>        <span class="nt">&quot;target&quot;</span><span class="p">:</span> <span class="s2">&quot;es6&quot;</span><span class="p">,</span>
</div><div class='line'>        <span class="nt">&quot;moduleResolution&quot;</span><span class="p">:</span> <span class="s2">&quot;node&quot;</span><span class="p">,</span>
</div><div class='line'>        <span class="nt">&quot;allowJs&quot;</span><span class="p">:</span> <span class="kc">false</span>
</div><div class='line'>    <span class="p">},</span>
</div><div class='line'>    <span class="nt">&quot;exclude&quot;</span><span class="p">:</span> <span class="p">[</span>
</div><div class='line'>        <span class="s2">&quot;node_modules&quot;</span>
</div><div class='line'>    <span class="p">]</span>
</div><div class='line'><span class="p">}</span></div></code></pre></td></tr></table></div></figure>




<br/>


<h3>test</h3>

<p>Now that Node.js and DynamoDB is installed on the build machine (actually a container) and the application is transpiled into ES6 JavaScript that node can directly understand, it’s now time to run all the tests.</p>

<p>Once again, I’m taking over the inferred behavior of CircleCI using the “override” keyword and call into a predefined npm script.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>test:
</div><div class='line'>  override:
</div><div class='line'>    - npm test</div></code></pre></td></tr></table></div></figure>


<p>When the “npm test” command runs, behind the scenes npm looks into the “scripts” section of the “package.json” file to figure out what to execute.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
</pre></td><td class='code' width='100%'><pre><code class='json'><div class='line'><span class="err">//</span> <span class="err">package.json</span>
</div><div class='line'><span class="s2">&quot;scripts&quot;</span><span class="err">:</span> <span class="p">{</span>
</div><div class='line'>    <span class="nt">&quot;start&quot;</span><span class="p">:</span> <span class="s2">&quot;node ./bin/www&quot;</span><span class="p">,</span>
</div><div class='line'>    <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;node ./tests/runUnitTests.js&quot;</span>
</div><div class='line'>  <span class="p">}</span></div></code></pre></td></tr></table></div></figure>


<p></p>

<p>Via this lookup, it’s going to find and execute the “runUnitTests.js” file, which loads the jasmine test framework and executes the tests via another configuration file — “jasmine.json”.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
</pre></td><td class='code' width='100%'><pre><code class='javascript'><div class='line'><span class="c1">// runUnitTests.js</span>
</div><div class='line'><span class="kd">var</span> <span class="nx">Jasmine</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jasmine&#39;</span><span class="p">);</span>
</div><div class='line'><span class="kd">var</span> <span class="nx">jas</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Jasmine</span><span class="p">();</span>
</div><div class='line'><span class="nx">jas</span><span class="p">.</span><span class="nx">loadConfigFile</span><span class="p">(</span><span class="s1">&#39;./tests/unit/jasmine.json&#39;</span><span class="p">);</span>
</div><div class='line'><span class="nx">jas</span><span class="p">.</span><span class="nx">execute</span><span class="p">();</span></div></code></pre></td></tr></table></div></figure>


<p>“jasmine.json” file specifies where the tests and test helpers are and adjusts certain test behaviour. For example here I specified that I don’t want tests to stop running on failures because I would like to get a complete feedback. I also specified that tests should run in random order. All my tests in this project (unit / integration) are isolated from each other, so I should be able to run them in any order.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
<span class='line'>12</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>// jasmine.json
</div><div class='line'>{
</div><div class='line'>  &quot;spec_dir&quot;: &quot;tests/unit&quot;,
</div><div class='line'>  &quot;spec_files&quot;: [
</div><div class='line'>    &quot;./*[sS]pec.js&quot;
</div><div class='line'>  ],
</div><div class='line'>  &quot;helpers&quot;: [
</div><div class='line'>    &quot;./helpers/*.js&quot;
</div><div class='line'>  ],
</div><div class='line'>  &quot;stopSpecOnExpectationFailure&quot;: false,
</div><div class='line'>  &quot;random&quot;: true
</div><div class='line'>}</div></code></pre></td></tr></table></div></figure>


<p>Only when all tests run successfully, will the build continue to the next step and deploy the application to production.</p>

<h2>From CI to CD — Taking the next step</h2>

<p>At this point I’ve created a complete CI pipeline where at each commit to a branch a build will kick in, compile the codebase and run all the tests. Now all developers can integrate their work as early as possible and get continuous feedback from the build server.</p>

<p>However, if you and your team has invested into the CI pipeline enough that you trust the depth and breadth of feedback you receive from it, you can take the next step into continuous deployment.</p>

<p>Of course nothing forces you to deploy directly to production, automatically deploying to a staging environment for a final round of Q/A is definitely a more common approach.</p>

<br/>


<h3>dependencies &amp; deployment</h3>

<p>Below are the build steps where I install <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli3.html">AWS Elastic Beanstalk CLI</a> with its dependencies and call the deploy command for the right branch and profile.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>dependencies:
</div><div class='line'>  pre:
</div><div class='line'>    - sudo apt-get install python-dev
</div><div class='line'>    - sudo pip install &#39;awsebcli==3.7.4&#39; --force-reinstall
</div><div class='line'>deployment:
</div><div class='line'>  production:
</div><div class='line'>    branch: master
</div><div class='line'>    commands:
</div><div class='line'>      - eb deploy --profile default</div></code></pre></td></tr></table></div></figure>


<p>It turns out that “python-dev” tools is a pre-requisite for AWS EB CLI. Notice that I only deploy the master branch to production. None of the other branch builds will run this deployment step.</p>

<p>If you think about what needs to happen behind the scenes for an actual deployment process, this configuration seems to be too little. For example, how does EB CLI know where to deploy the application in AWS ? or how does CircleCI authenticate with AWS on my behalf to make this deployment? So indeed, this is not the full story. There are two more pieces of the puzzle that I want to show you quickly.</p>

<p>By convention, “.elasticbeanstalk/config.yml” is the path that EB CLI looks for during the deployment. One of the key things in this file is the first section where the environment name is defined. “hackathonplanner” is the environment that is uniquely defined under my AWS account and this is how EB CLI knows where to deploy the package to.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table cellpadding="0" cellspacing="0"><tr><td class="gutter"><pre class="line-numbers"><span class='line'>1</span>
<span class='line'>2</span>
<span class='line'>3</span>
<span class='line'>4</span>
<span class='line'>5</span>
<span class='line'>6</span>
<span class='line'>7</span>
<span class='line'>8</span>
<span class='line'>9</span>
<span class='line'>10</span>
<span class='line'>11</span>
</pre></td><td class='code' width='100%'><pre><code class='text'><div class='line'>//.elasticbeanstalk/config.yml
</div><div class='line'>branch-defaults:
</div><div class='line'>  master:
</div><div class='line'>    environment: hackathonplanner
</div><div class='line'>global:
</div><div class='line'>  application_name: Hackathon-Planner
</div><div class='line'>  default_ec2_keyname: null
</div><div class='line'>  default_platform: 64bit Amazon Linux 2016.03 v2.1.3 running Node.js
</div><div class='line'>  default_region: eu-central-1
</div><div class='line'>  profile: eb-cli
</div><div class='line'>  sc: git</div></code></pre></td></tr></table></div></figure>


<p>The answer of the second question, which is, “how does CircleCI authenticate on my behalf to make this deployment happen” is below:</p>

<p><img src="/assets/ContinuousIntegration_Part3/AWS-Keys.png" alt="CircleCI AWS Keys Page" /></p>

<p>As you see, CircleCI has built in first class support for AWS. Just like it’s recommended on the configuration page above, I’ve created a unique <a href="https://aws.amazon.com/iam/">IAM user</a> in AWS and gave it deployment permissions to the “hackathonplanner” environment. Then I copy and pasted the “Access Key ID” and “Secret Access Key” over from AWS to CircleCI. Now CircleCI can deploy to my environment on my behalf. It’s that easy.</p>

<h2>Build results</h2>

<p>At the time of this writing I’ve got <a href="https://circleci.com/gh/hakant/HackathonPlannerAPI">72 builds queued and ran</a> both green and red.</p>

<p>If you look at one of the successful builds, let’s take <a href="https://circleci.com/gh/hakant/HackathonPlannerAPI/72">the last one</a>, you can see each and every step that were executed and their respective logs. </p>

<p>After uncollapsing the test step and reading through the logs, I noticed that for some reason my tests can not tear down DynamoDB tables anymore. It doesn’t fail any test since each test creates new tables with random names, so the build is still green and everything is fine. I need to dig in and understand what has changed in the meantime — while I was not paying attention. </p>

<p>This reminded me of <a href="https://vimeo.com/channels/1203692/204428794">a recent talk from Ian Cooper</a> where 17 mins in, he asks the audience if they deployed a piece of software and left it alone for a year, what would they expect when they come back. Would it still be up and running correctly or not? So the point is, things keep changing around our software (especially in the cloud) and when nothing is done, our software decays by itself.</p>

<p>Anyway, after this little segway into a different subject, I think it’s time to stop here. Thanks for reading and if you have any comments or questions you can write it below or tweet me at <a href="https://twitter.com/hakant">@hakant</a>!</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="twitter">
			<a href="https://twitter.com/hakant" class="twitter-follow-button" data-show-count="false">Follow @hakant</a>
		<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
		</div>
		<div class="date">








  


<time datetime="2017-03-25T09:48:02+01:00" data-updated="true" itemprop="datePublished">Mar 25<span>th</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ci/'>CI</a>, <a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/testing/'>testing</a>


</div>
		
			<span class="comments"><a href="/blog/2017/03/25/setting-up-continuous-delivery-for-a-node-dot-js-rest-api-part-2/#disqus_thread">Comments</a></span>
		

	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2017/03/25/setting-up-continuous-delivery-for-a-node-dot-js-rest-api-part-2/" itemprop="url">Setting Up Continuous Delivery for a Node.js REST API - Part 2</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h2>Introduction</h2>

<p><a href="/blog/2017/02/17/setting-up-continuous-integration-and-delivery-for-a-nodejs-rest-api/">In the first part</a> of this blog post, I shared some fundamental ideas that form as background information for what I want to achieve here. So if you haven’t read that one yet, I recommend you to <a href="/blog/2017/02/17/setting-up-continuous-integration-and-delivery-for-a-nodejs-rest-api/">check it out</a>.</p>

<p>A few months back, I decided to convert my <a href="https://github.com/hakant/HackathonPlannerAPI">hobby project — Hackathon Planner API</a> from pure Javascript to TypeScript and <a href="/blog/2016/11/08/converting-a-node-dot-js-express-api-to-typescript/">wrote a blog post about it</a>. This time I sat down to build an Automated Test Suite and a <a href="https://www.martinfowler.com/articles/continuousIntegration.html">Continuous Delivery (CD)</a> pipeline around it.</p>

<p>Effective automated testing is a natural prerequisite for Continuous Integration &amp; Delivery. How can it not be? If you’re not getting quick and broad feedback from your software, how can you delivery frequently? So having a testable architecture and an effective test strategy is very crucial. Let’s dive in.</p>

<h2>Right Architecture for Subcutaneous Testing</h2>

<p>I’m a huge fan of <a href="https://martinfowler.com/bliki/SubcutaneousTest.html">subcutaneous testing</a>. This type of testing starts right under the UI layer with a large scope (which preferably spans all the way down to the data store) can have a great return on investment. On <a href="https://m.facebook.com/notes/kent-beck/making-making-manifesto/857477870951745/">Kent Beck’s feedback chart</a> it would score high up and to the right: <strong>fast and broad feedback</strong>.</p>

<p><img src="/assets/ContinuousIntegration_Part2/Kent_Beck_Feedback_Chart.png" alt="Kent Beck's Feedback Chart" /></p>

<p>So now that we want to target our automated tests below the delivery mechanism layer (UI, Network etc.), this is where an important architectural decision comes into question. What is the main boundary of my application? Where does my significant business logic start? Plus, how can I make my application boundary very visible and clear to all developers? If you follow down this path of thinking, one nice place to end up is a combination of <a href="https://en.wikipedia.org/wiki/Command_pattern">command</a> and <a href="https://en.wikipedia.org/wiki/Mediator_pattern">mediator</a> patterns.</p>

<p>The combination of these patterns is about sending commands down through a very narrow facade, where every command has a very clean input and output “<a href="https://en.wikipedia.org/wiki/Data_transfer_object">data transfer objects</a>” or POCO’s, POJO’s.. whatever you like to call them depending on your stack of choice. They’re simply objects that carry data and no behavior. </p>

<p>To be able to use this pattern in <a href="https://github.com/hakant/HackathonPlannerAPI">my REST API</a>, I’ve created a simple module in TypeScript that allows me to execute commands and optionally get results from them. It’s here: <a href="https://github.com/hakant/TypeScriptCommandPattern">TypeScriptCommandPattern</a>.</p>

<p>In the example below, you can see how a test request is sent down to the executor and a result is returned back.</p>

<br/>


<script src="https://gist.github.com/hakant/837f08708feed35b2d02b99269f0e916.js"></script>


<p>And here is how a “Hello World” style command handler looks like. Notice that it has a clean request and response definitions. At the end of the implementation we make sure that the handler is registered and mapped to the request. In this structure handlers are singleton objects and they can later be resolved by the type of the request and then get executed.</p>

<br/>


<script src="https://gist.github.com/hakant/c4c29c9d6e98fb3a85c674a4b0ad6b28.js"></script>


<h2>Using this pattern in a real world Node.js REST API</h2>

<p>One great architectural benefit of this pattern is that it allows you to nicely separate an application into many independent scenarios — <a href="https://lostechies.com/jimmybogard/2015/07/02/ndc-talk-on-solid-in-slices-not-layers-video-online/">vertical slices</a>. Take a look at <a href="https://github.com/hakant/HackathonPlannerAPI/tree/master/scenarios">these scenarios from Hackathon Planner</a>:</p>

<p><img src="/assets/ContinuousIntegration_Part2/Hackathon_Planner_Scenarios.png" alt="Kent Beck's Feedback Chart" /></p>

<p>Each of these TypeScript modules are a vertical slice. They’re the full story. Yes they make use of other external modules when necessary, but when developers read through these scenarios, they get the full picture. And if code sharing between these scenarios are done wisely (with correct abstractions), then a change in one scenario is contained and does not necessarily affect any others.</p>

<p>Let’s take a look at the implementation of one of these scenarios and extract some key properties. Let’s pick the scenario in “GetIdeas.ts”:</p>

<br/>


<script src="https://gist.github.com/hakant/6c38b895807a4d721c8c367a5117826f.js"></script>


<ul>
<li><p>Line 3–4: Imports the base async command handling structure and also the container to register itself at the end of the file.</p></li>
<li><p>Line 6–9: External modules that this handler uses.</p></li>
<li><p>Line 11–12: A module that is used by multiple scenarios. Be careful, I say “used” not “reused”. Remember the “<a href="http://udidahan.com/2009/06/07/the-fallacy-of-reuse/">fallacy of reuse</a>”. This module (IdeaPrePostProcessor) is used to massage and sanitize the Idea entities before they’re sent to the user interface and before they’re written to the database. Multiple scenarios use this module the exact same way and for the same need. There are no slight variations per scenario, that’s why it’s a right abstraction and that’s why it’s “use”, not “reuse”.</p></li>
<li><p>Line 14–16: Since our handler is an async one (because it’s accessing the database), it implements the AsyncCommandHandler&lt;TRequest, TResponse> and implements the HandleAsync method that returns a Promise of GetIdeasReponse object.</p></li>
<li><p>Line 17–38: Complete vertical implementation of the handler. It’s basically scanning the database for all the ideas, sorting them based on an algorithm, encapsulating them in the response object and return. Notice that at line 25, the “await” keyword is used. It’s a simple and very readable way of representing asynchronous code. It exists in recent versions of TypeScript as well as in ES7.</p></li>
<li><p>Line 42–47: Request and response objects that are used by this handler are defined and exported. These objects should be available to the rest of the application as well.</p></li>
<li><p>Line 50–52: A singleton instance of the handler is instantiated and registered to the type of the request object. Based on application needs, this can be made more complex and sophisticated. Statically typed languages incorporate lots of ideas around IoC containers whereas dynamically typed languages like javascript, not so much. Also keep in mind that these TypeScript generic constructs only exist at design time. They don’t exist in the transpiled javascript and that makes it impossible to discover or scan these constructs at runtime.</p></li>
</ul>


<h2>Simple &amp; Stupid ExpressJS Routes</h2>

<p>If you have experience with building MVC type web applications or REST API’s you’re probably familiar with the idea of controllers. Routes are the same concept in <a href="http://expressjs.com">ExpressJS</a>. Keeping your routes and controllers nice and clean is a good discipline to have. Remember, we want to contain our core application logic and try not to leak it outside as much as possible. Not to frameworks, not to external libraries.</p>

<p>Hackathon Planner’s most significant route is the Ideas route where ideas are being CRUD and a few further actions are taken against them. Code below shows the routes defined in there. Notice how clean it reads and how all business logic is kept out of it. The only thing these routes do is to pass requests and responses up and down the stream.</p>

<br/>


<script src="https://gist.github.com/hakant/85fbfa3f3d77f82c2b17457a96356d09.js"></script>


<h2>Testing all the Scenarios</h2>

<p>The structure of the software created so far lends itself nicely to the subcutaneous testing style discussed earlier. So I take advantage of this by taking the following actions in the tests:</p>

<ul>
<li><p>Remove the ExpressJS layer that normally sits on top. This is a delivery mechanism and I don’t necessarily need it to test my business logic — since I’ve already separated that logic clearly out of this layer.</p></li>
<li><p>Load all scenario handlers together with the real data store (or a realistic emulator).</p></li>
<li><p>Shoot requests &amp; verify responses.</p></li>
<li><p>In some cases, if verifying the response alone isn&rsquo;t sufficient, go further and directly check the data store for verifying the side effects. In my case it wasn’t necessary, I could both act and verify using my handlers alone.</p></li>
</ul>


<p>Let’s take a look at a few of these tests. Below is a part of <a href="https://jasmine.github.io/">jasmine</a> spec that tests inserting and fetching ideas by running several scenarios.</p>

<br/>


<script src="https://gist.github.com/hakant/a2d1c53fdaa5e7c0d99eeb8e8b4022e2.js"></script>


<p>Here are a few key properties of these tests:</p>

<ul>
<li><p>Lines 17–26: Before each test new NoSql tables are created and after each test they’re dropped. This makes every test run in a sandbox isolated from one another. So they can all run in any random order. In general, this is a characteristic of a unit test, not an integration test. So here we have the best of both worlds!</p></li>
<li><p>All tests run against a DynamoDb local emulator. So the feedback coming from the database is real. I trust that the Amazon team behind DynamoDb makes sure that the emulator behaves exactly the same as the real one in the cloud.</p></li>
<li><p>Integration tests are slow right? No, not if you don’t test against user interfaces, or have many number of network calls, or use slow data storage devices. These tests don’t get into any complexity of testing against a UI; they don’t bring up a web server and make excessive number of network calls; and they make use of an in memory database emulator running on the same box. These 15 tests run in ~2 seconds even though each of them setup and tear down their data tables. So you can run quite a lot of these in a few minutes.</p></li>
<li><p>By their nature, integration tests are broad. They give broad feedback. But this is a trade off because when they fail, you have to dig a little deeper to understand exactly what failed in comparison to the unit tests that are tiny and focused. But that’s a tradeoff I like to make in general.</p></li>
<li><p>Having said that, I’m by no means trying to trash the value of unit tests here. If I see the need — like any piece of code that is significant for the system and does interesting things — I’ll go and unit test that part in isolation. Especially code that’s heavy on algorithmic work. So unit tests are valuable when they’re implemented for the right code against the right abstraction.</p></li>
<li><p>Last but not least, these type of tests (i.e subcutaneous) interacts with the system right at the outside of the significant boundary. This means as long as feature requirements don’t change, these tests remain valid and useful. They can survive large refactorings because they’re not coupled to the implementation details! This is a huge deal in my opinion.</p></li>
</ul>


<p>In next and the last part of this series, I would like to write a few things about my experience with setting up a CD pipeline using <a href="https://circleci.com">CircleCI</a>, which transpiles all TypeScript files, installs dependencies, runs tests and deploys to <a href="https://aws.amazon.com/elasticbeanstalk/">AWS Elastic Beanstalk</a>.</p>

<p>Thanks for reading.</p>

<p>~ Hakan</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="twitter">
			<a href="https://twitter.com/hakant" class="twitter-follow-button" data-show-count="false">Follow @hakant</a>
		<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
		</div>
		<div class="date">








  


<time datetime="2017-02-17T22:01:28+01:00" data-updated="true" itemprop="datePublished">Feb 17<span>th</span>, 2017</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ci/'>CI</a>, <a class='category' href='/blog/categories/architecture/'>architecture</a>, <a class='category' href='/blog/categories/testing/'>testing</a>


</div>
		
			<span class="comments"><a href="/blog/2017/02/17/setting-up-continuous-integration-and-delivery-for-a-nodejs-rest-api/#disqus_thread">Comments</a></span>
		

	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2017/02/17/setting-up-continuous-integration-and-delivery-for-a-nodejs-rest-api/" itemprop="url">Setting Up Continuous Delivery for a Node.js REST API - Part 1</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h2>Introduction</h2>

<p>A few months back, I decided to convert my <a href="https://github.com/hakant/HackathonPlannerAPI">hobby project &ndash; Hackathon Planner API</a>
from pure Javascript to <a href="https://www.typescriptlang.org/">TypeScript</a> and <a href="/blog/2016/11/08/converting-a-node-dot-js-express-api-to-typescript/">wrote a blog post about it</a>.
This time I sat down to build an Automated Test Suite and a Continuous Delivery (CD) pipeline around it.</p>

<p>Hackathon Planner API is essentially a REST API written in <a href="https://nodejs.org/en/">Node.js</a> and <a href="http://expressjs.com/">Express</a>.
Stores its data in a NOSQL database (<a href="https://aws.amazon.com/dynamodb/">DynamoDB</a>) and hosted on
<a href="https://aws.amazon.com/elasticbeanstalk/">AWS Elastic Beanstalk</a>.</p>

<p>I thought I would best write this up in 2 blog posts &ndash; due to the fact that most of what I did in this repository
is based on some fundamental concepts which I&rsquo;ve been reading and thinking about in the last few years.</p>

<p>In this post, I would like to touch on a few of these ideas that guided me in my refactoring decisions for
making the codebase cleaner, less coupled and more testable.</p>

<p>In the next post, I&rsquo;ll share some more details and examples from the codebase.</p>

<h2>Enabling Continuous Integation &amp; Delivery</h2>

<p>If you are not very familiar with the terms &ldquo;Continuous Integration&rdquo; (CI) or &ldquo;Continuous Delivery&rdquo; (CD) I suggest checking out
<a href="https://www.thoughtworks.com/continuous-integration">ThoughtWorks website</a>
and <a href="https://www.martinfowler.com/articles/continuousIntegration.html">Martin Fowler&rsquo;s post</a> to learn more about
these software development practices.</p>

<p>I&rsquo;ve intentionally used the word &ldquo;enabling&rdquo; in the title above. I&rsquo;ve seen many brownfield projects
where the team wants to start practicing CI; however, depending on the age
and size of the project this may turn out to be <strong>very difficult, sometimes even impossible</strong>. These are not
practices that can be applied to a project only from the outside. They can&rsquo;t always be easily introduced as
an afterthought either, they have to be built and enabled inside out; and it takes time &amp; effort to get there!</p>

<p>The way I see it; practicing CI or CD are kind of a &ldquo;high performance state&rdquo; a team reaches after getting A
LOT OF THINGS RIGHT; especially around system architecture and automated testing. Skills of the team members
also matter, big time! Committing to trunk everyday without breaking stuff and more importantly, always introducing
a right amount of tests at each new check-in is not an easy task for everyone.</p>

<h2>Clean Architecture</h2>

<p>One of the important lessons I learned from Robert C. Martin&rsquo;s talk <a href="https://vimeo.com/97530863">Clean Architecture and Design</a>
(more resources <a href="https://8thlight.com/blog/uncle-bob/2012/08/13/the-clean-architecture.html">here</a>) is that, it&rsquo;s
almost always a good idea to keep your business logic, the heart of your system, clean from external concerns like
frameworks and delivery mechanisms (web frameworks, native application hosts, operating systems etc.).</p>

<p>This is beneficial in many ways. Keeps your business logic clean and free from the complexities of the environment around
it. It also enables great automated testing capabilities which is probably the most important prerequisite of
&ldquo;Continuous Integration&rdquo; way of working and delivering software.</p>

<p>Btw, just because I&rsquo;m referring to Robert C. Martin&rsquo;s clean architecture here doesn&rsquo;t mean I agree with everything
he&rsquo;s suggesting there &ndash; like f.ex his claim on: &ldquo;storage is an insignificant detail&rdquo;. I&rsquo;d still like to think of
storage interaction as an integral part of my system. More on that in a bit.</p>

<h2>Vertical Slices instead of Horizontal Layers</h2>

<p>We&rsquo;ve all built <a href="https://en.wikipedia.org/wiki/Multitier_architecture">n-tier applications</a> where software is structured
in horizontal layers &ndash; most typical layers being Presentation, Business and Data Access. I&rsquo;ve built many
applications in this way and it&rsquo;s almost certain that I&rsquo;ll come across many others in the future.</p>

<p>What&rsquo;s the promise of n-tier and how did it become so widespread? I think this sentence
<a href="https://en.wikipedia.org/wiki/Multitier_architecture">from wikipedia</a> sums it up:</p>

<blockquote><p>N-tier application architecture provides a model by which developers can create flexible and
reusable applications.</p></blockquote>

<p>In recent years; gotten tired of repeating problems introduced by organically grown n-tier applications &ndash; like
tight-coupling, bloated classes or services with multiple responsibilities,
<a href="https://www.sandimetz.com/blog/2016/1/20/the-wrong-abstraction">organically introduced premature/wrong abstractions</a>;
all leading up to code that has become unreadable and hard to reason about.
You know you&rsquo;re in a &ldquo;generic, reusable n-tier application&rdquo; when you have to jump to definitions up and down
OVER AND OVER AGAIN in order get a slightest clue about what a specific scenario is trying to achieve.</p>

<p>Luckily, there are alternative ideas in the community. One of my favorites is the direction <a href="https://twitter.com/jbogard">Jimmy Bogard</a> is taking
in his talk <a href="https://lostechies.com/jimmybogard/2015/07/02/ndc-talk-on-solid-in-slices-not-layers-video-online/">SOLID in Slices not Layers</a>,
and his library <a href="https://github.com/jbogard/MediatR">MediatR</a> that I&rsquo;ve come to learn and love in the
last few years.</p>

<p>I&rsquo;ve built a few applications using MediatR where I implemented all scenarios (think of these as endpoints in a
REST API) in vertical slices and kept the shared code between them to a minimum. I really enjoyed the
outcome. Readability, <a href="https://en.wikipedia.org/wiki/Cohesion_(computer_science)" >cohesion</a> and
<a href="https://lostechies.com/jimmybogard/2016/10/24/vertical-slice-test-fixtures-for-mediatr-and-asp-net-core/">testability</a>
of these applications went really up.</p>

<p>Recently I listened <a href="https://www.dotnetrocks.com/?show=1405">Scott Allen on a podcast</a> where he mentioned
he&rsquo;s also a fan of vertical slicing and he has a <a href="http://odetocode.com/blogs/scott/archive/2016/11/29/addfeaturefolders-and-usenodemodules-on-nuget-for-asp-net-core.aspx">blog post on a related idea</a>.</p>

<p>One other lecture I recommend seeing is by Udi Dahan from NDC Oslo 2016: <a href="https://vimeo.com/131757759">Business Logic, a different perspective</a>
where he talks about <a href="http://udidahan.com/2009/06/07/the-fallacy-of-reuse/">the fallacy of reuse</a>.</p>

<p>Last but not least, I wrote a tiny <a href="https://github.com/jbogard/MediatR">MediatR</a> style
<a href="https://github.com/hakant/TypeScriptCommandPattern">application/command facade in TypeScript</a>. I do make use
of this module in <a href="https://github.com/hakant/HackathonPlannerAPI">HackathonPlannerAPI</a> and I&rsquo;ll write more about
it in my next post.</p>

<h2>Resist the temptation of sharing and reusing code unless you have a good justification and the right abstraction</h2>

<p>Before you decide to share code between application scenarios, think twice, think three times. If you really have
to do it, make sure you build a very clear interface around that component or module. Like Udi Dahan says in his
talk (shared above), USE this component from multiple scenarios, do not RE-USE it: If you find yourself tweaking the
component for each new scenario that&rsquo;s using it, you probably got the boundary wrong. Find the right boundary or
refactor this component back into the scenarios and stop sharing/reusing it.</p>

<p>In <a href="https://medium.com/@rdsubhas/10-modern-software-engineering-mistakes-bc67fbef4fc8#.k139s48qo">one of my favorite medium posts</a>
I&rsquo;ve read recently, the author really nails it:</p>

<blockquote><p>When Business throws more and more functionality (as expected), we sometimes react like this:
<br/><br/>
<img src="/assets/ContinuousIntegration_Part1/Shared_Logic_1.png" alt="Shared Business Logic-1" />
<br/><br/>
Instead, how should we have reacted:
<br/><br/>
<img src="/assets/ContinuousIntegration_Part1/Shared_Logic_2.png" alt="Shared Business Logic-1" />
<br/><br/></p></blockquote>

<h2>Unit or Integration&hellip; Let&rsquo;s call them all TESTING.</h2>

<p>For a good chunk of my development career, I was told that the &ldquo;unit&rdquo; in unit test is a class. So as a result,
my programming style evolved in a way that I always felt the need to design my classes with this type of testing
in mind: always being able to isolate a class from its surroundings.</p>

<p>I understand that some call this <a href="http://david.heinemeierhansson.com/2014/test-induced-design-damage.html">Test-induced design damage</a>.
Somehow in the world of C#, using Dependency Injection and programming against interfaces still feels very natural
to me. So for me, this is not a big deal and I still find it useful to be able to swap things in and out as
necessary and in every level of my implementation.</p>

<p>However, what I&rsquo;ve come to learn eventually is this: <strong>coupling your tests to your implementation details will
kill you</strong>. Just like <a href="https://vimeo.com/68375232">Ian Cooper explains in his brilliant talk at NDC Oslo</a>. So
if you&rsquo;re writing tests for each and every single one of your classes, it&rsquo;s very likely that you&rsquo;re doing it wrong
and soon you&rsquo;ll find out that your tests are slowing you down instead of giving you the feedback and agility you
were hoping for when you started.</p>

<p>Instead, <strong>find your significant boundaries</strong>. Meaningful boundaries that are composed of one or more classes and
that represent business needs. The key is this: even if your implementation details change, after let&rsquo;s say a BIG
refactoring, your tests SHOULD NOT need to change.</p>

<p>What is a better significant boundary than the whole application boundary? This is essentially what a MediatR style
pattern gives you. One narrow facade for your whole application. What a great boundary to write your tests against!</p>

<h2>Speed of tests matter but technology is changing too</h2>

<p>One big reason (heck, maybe the only reason) why people will tell you to design your system in a
way that you can swap out your database in favor of a test double (f.ex by using a repository pattern) is the speed
of tests.</p>

<p>This could be a necessary evil back in the days where databases and infrastructure was bulky and slow. But is
this still true? For <a href="https://github.com/hakant/HackathonPlannerAPI">Hackathon Planner API project</a>
I wrote 15 tests which execute all application scenarios against a <a href="https://aws.amazon.com/blogs/aws/dynamodb-local-for-desktop-development/">DynamoDB Local Emulator</a>,
so nothing is being swapped in or out on the application side but each test sets up and tears down the NOSQL
document store &ndash; so that all tests are completely isolated from each other.</p>

<p>The result is amazing. It takes ~2 seconds to run all the tests. Let&rsquo;s say if my application grows in
size in the future and that I had to execute 300 tests, it would still take me below a minute to
run all the tests!</p>

<p>I know this example will not represent every project out there in the wild for different sorts of reasons
but when it does, it definitely blurs the line between &ldquo;Service&rdquo; and &ldquo;Unit&rdquo; tests in
<a href="https://martinfowler.com/bliki/TestPyramid.html">the test pyramid</a>:</p>

<br/>


<p><img src="https://martinfowler.com/bliki/images/testPyramid/test-pyramid.png" width="400" alt="Test-Pyramid" /></p>

<br/>


<p>Thanks for reading. In Part 2 there will be code, I promise.</p>

<blockquote><p><strong>Update</strong>:
<br/><br/></p>

<p>Part 2 is now available! You can <a href="/blog/2017/03/25/setting-up-continuous-delivery-for-a-node-dot-js-rest-api-part-2/">reach it here</a>.</p></blockquote>

<p>~Hakan</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="twitter">
			<a href="https://twitter.com/hakant" class="twitter-follow-button" data-show-count="false">Follow @hakant</a>
		<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
		</div>
		<div class="date">








  


<time datetime="2016-11-08T21:32:05+01:00" data-updated="true" itemprop="datePublished">Nov 8<span>th</span>, 2016</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/express/'>express</a>, <a class='category' href='/blog/categories/node-dot-js/'>node.js</a>, <a class='category' href='/blog/categories/typescript/'>typescript</a>


</div>
		
			<span class="comments"><a href="/blog/2016/11/08/converting-a-node-dot-js-express-api-to-typescript/#disqus_thread">Comments</a></span>
		

	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2016/11/08/converting-a-node-dot-js-express-api-to-typescript/" itemprop="url">5 Quirks of Converting a Node.js Express API to TypeScript</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I started using TypeScript as part of a project I&rsquo;m working on. If you&rsquo;re new to TypeScript or
aren&rsquo;t yet sure about the benefits it can bring to your Javascript codebases, I recommend seeing
<a href="https://channel9.msdn.com/Events/Build/2016/B881">this presentation from Anders Hejlsberg (Build 2016)</a>.</p>

<p>One thing I really like about TypeScript is that it&rsquo;s a superset of Javascript, which means all Javascript
you wrote until now is already valid TypeScript. This makes it possible for anyone to come
into TypeScript and adopt it as much or as little as they want. Anders calls this &ldquo;turning the knob&rdquo;
experience. If you want to go all the way in with the type system, you can do so. Or if you only want to
use it in certain parts of your codebase, you can do that too.</p>

<p>As I learned more about TypeScript, I got convinced that I can benefit from it in most of my Javascript projects,
in particular, the ones that involve rich business domains. As an experiment, I started
converting <a href="https://github.com/hakant/HackathonPlannerAPI">the backend of Hackathon Planner</a>, written in <a href="https://nodejs.org/en/">Node.js</a>
and <a href="http://expressjs.com/">Express</a>, into TypeScript.</p>

<p>All in all, it&rsquo;s been a smooth experience but if
you&rsquo;re a developer yourself, you know that this type of refactorings never happen on a straight line, there
are always bumps and quirks along the way.</p>

<p>Here are a number of things I experienced as I gradually converted all of the codebase from ES6 Javascript
to TypeScript. This repository is open source and on <a href="https://github.com/hakant/HackathonPlannerAPI">GitHub</a>.
TypeScript version of the code might still be on a separate branch if I haven&rsquo;t merged it yet.</p>

<h2>1. At transition, module loading can get tricky in Node.js</h2>

<p>TypeScript shares the <a href="https://www.typescriptlang.org/docs/handbook/modules.html">same concept of a module as ES6</a>.
TypeScript&rsquo;s module import and export syntax is very similar to its ES6 counterpart but the <a href="https://nodejs.org/docs/latest/api/modules.html">CommonJS
module system</a> that Node.js uses is different.</p>

<p>I wanted to slowly port my Javascript to TypeScript so that I can continue making releases in between.
Obviously, this means that part of the code would be transpiled from TypeScript while the other part is
originally Javascript. In many occasions I had to load a module from a .js file and the target
module was transpiled from a .ts (TypeScript) file. <a href="https://github.com/Microsoft/TypeScript/issues/2719">This can cause issues</a>.</p>

<p>Look at the code below and see what happens when &ldquo;ideas.js&rdquo; has to load a module from &ldquo;AdminRepository.ts&rdquo;.
All of a sudden you have to use the &ldquo;default&rdquo; property to be able to access the exported object.
Eventually, when the consumer (idea.js) is also converted to TypeScript, the problem will go away.</p>

<br/>




<script src="https://gist.github.com/hakant/d68576a8d9cc9ed85e8d3c649ad8a856.js"></script>


<h2>2. Adding Type Definition Files to a Project</h2>

<p>Type definition files let you consume third party libraries as if they were written in TypeScript. So
you get all the benefits of type checking, intellisense and all other TypeScript design &amp; compile time
goodness even when the third party library is written in pure Javascript.</p>

<p>Before 2.0 release of TypeScript, finding and using these type definition files could get a bit <a href="https://www.davevoyles.com/2016/02/16/how-to-add-type-definitions-to-a-typescript-project/">painful and
confusing</a> &ndash;
same goes for <a href="https://medium.com/@mweststrate/how-to-create-strongly-typed-npm-modules-1e1bda23a7f4#.7ur75n1hf">creating them</a>.
TypeScript 2.0 fixed some of these issues by introducing a <a href="https://blogs.msdn.microsoft.com/typescript/2016/09/22/announcing-typescript-2-0/#simplified-declaration-file-dts-acquisition">simplified declaration file
acquisition model</a>.</p>

<p>In node.js, in order to grab the underscore.js package, you&rsquo;d use:</p>

<blockquote><p>npm install underscore &mdash;save</p></blockquote>

<p>Now, if you also want to use this package from TypeScript, with strong typing, you&rsquo;ll have to download
the necessary type declaration file as well:</p>

<blockquote><p>npm install @types/underscore &mdash;save</p></blockquote>

<p>Starting with TypeScript 2.0, these type definition files are regular npm packages.</p>

<p>After downloading the type definition file, VS Code stops complaining. Furthermore, I get all type safety
features and intellisense while using this library, which is what I want and why I use TypeScript.</p>

<p><img src="/assets/Node_Express_TypeScript/types_packages.png" alt="Types Packages" /></p>

<p>On the other hand, sometimes a library you&rsquo;re using might not have a type definition file. For example, I&rsquo;m using
a passport extension library called &ldquo;passport-github2&rdquo; which doesn&rsquo;t have a definition file yet
(and probably never will). Inside any TypeScript file that uses this library, VSCode complains that it doesn&rsquo;t
understand this library. TypeScript compilation also results in the same error. But even though the typing file
is missing, the actual library is there and it works during run-time.</p>

<p>But of course we&rsquo;ve a problem here. The problem is that the TypeScript compiler will complain about this missing type definition file
forever. Being a good developer, what you want to do is to avoid having these kinds of error messages lying around
and being ignored.</p>

<p><img src="/assets/Node_Express_TypeScript/missing_typing.png" alt="Missing Typings" /></p>

<p>Having said this, it&rsquo;s worth mentioning that
<a href="https://medium.com/@sam.verschueren/the-one-thing-that-keeps-me-from-using-typescript-839e9bd464d7#.fg5tvva5g">people are complaining</a>
about this aggressive behavior of TypeScript, as it eagerly wants all 3rd party packages to have type definition files. But
there&rsquo;s probably <a href="https://github.com/Microsoft/TypeScript/pull/11446">a solution coming</a>.</p>

<p>Until then, there are 2 possible solutions:</p>

<ul>
<li>Set &ldquo;allowJs&rdquo; compiler option to true (in ts.config file). Although I should warn you that this will not only allow
third party packages to be consumed without type definitions, it will also allow any developer to put pure
javascript code into your project.</li>
<li>Another solution is to declare an <a href="https://www.typescriptlang.org/docs/handbook/modules.html#ambient-modules">ambient module</a>
for that library in a separate file &ndash; either marking it with &lsquo;any&rsquo; keyword or with proper types.</li>
</ul>


<p>I chose the latter, because I noticed that &ldquo;allowJs&rdquo; flag has far bigger consequences. It silences a bunch of
other types of errors/warnings which I would like to be informed about. Here is how those ambient modules
look like:</p>

<p><img src="/assets/Node_Express_TypeScript/ambient_modules.png" alt="Ambient Modules" /></p>

<h2>3. Incorrect / Incomplete Type Definition Files</h2>

<p>Sometimes a type definition file (.d.ts file) turns out to be incorrect or incomplete. The screenshot
below shows a situation where the package &ldquo;aws-sdk&rdquo; has an incomplete type definition. It doesn&rsquo;t
know that &ldquo;endpoint&rdquo; property exists even though it does exist in <a href="http://docs.aws.amazon.com/amazondynamodb/latest/gettingstartedguide/GettingStarted.NodeJs.01.html">AWS documentation</a>.</p>

<p><img src="/assets/Node_Express_TypeScript/incorrect_d.ts_file.png" alt="Incorrect type declarations" /></p>

<p>I literally went into the type declaration file I downloaded via npm and added the field &ldquo;endpoint&rdquo;
in there to fix the problem. Probably I have to commit this file into source control now. Unfortunately
I couldn&rsquo;t find a best practice that explains how to properly handle these situations. For now, I&rsquo;ll go
with the solution of manually fixing the definition file and adding it into the source control. Below you
can see the patch I made to the declaration file of AWS-SDK (line commented out).</p>

<p><img src="/assets/Node_Express_TypeScript/clientconfigpartial_d.ts.png" alt="ClientConfigPartial-AWS-SDK" /></p>

<h2>4. Dynamic Augmentation of Javascript Objects</h2>

<p>A very common pattern in javascript is to dynamically extend or augment an object with new or complementary
behavior. Here below, I&rsquo;m using <a href="http://bluebirdjs.com">bluebird.js</a> to convert a callback oriented API
to a Promise based API. All of a sudden though, TypeScript doesn&rsquo;t know about these new &ldquo;async&rdquo; methods that
bluebird has plugged into the dynamodb client.</p>

<p><img src="/assets/Node_Express_TypeScript/promisify_all.png" alt="Bluebird-Promisify-All" /></p>

<p>The solution is to either declare this object as a new interface or mark it as &ldquo;any&rdquo;,
as suggested <a href="https://github.com/Microsoft/TypeScript/issues/8685">here</a>). I&rsquo;ve chosen the first, a more type-safe
approach, and declared my new type in the &ldquo;aws-sdk&rdquo; type declaration file, which solved the problem in
a nicer way imho. See the DynamoDBAsyncClient interface definition below:</p>

<p><img src="/assets/Node_Express_TypeScript/dynamodb_async_client_declaration.png" alt="DynamoDB_Async_Client_Declaration" /></p>

<h2>5. Using import or export in your TypeScript file turns it into a module</h2>

<p>Both in TypeScript and ES6, any file containing a top-level import or export is considered a module. So
right after you use one of these keywords in your Javascript or TypeScript file, it will start behaving like
a module. I stumbled upon this while I was trying to implement an interface that I had created in a separate
file.</p>

<p>Let&rsquo;s first look at a simple case that doesn&rsquo;t make use of modules. Here below there&rsquo;s an interface and its
implementation right below it. See how AdminRepository.ts refers to IAdminRepository interface without
any ceremony.</p>

<br/>




<script src="https://gist.github.com/hakant/ce9a6521a16d871bb652c2f41299312d.js"></script>




<script src="https://gist.github.com/hakant/7c25b55660deffb5556df2357ab5708b.js"></script>


<p>Now look at these other two files, in which the interface exposes a third party object and therefore has to
import that third party module. Note that index.ts can&rsquo;t just refer to that interface anymore, without
actually importing it.</p>

<br/>




<script src="https://gist.github.com/hakant/126bbcdaa477680e4ace2021f9dedd3e.js"></script>




<script src="https://gist.github.com/hakant/88d0907ab7f3c090b4d4404a31c079c5.js"></script>


<p>By the way, I also noticed that <a href="https://github.com/Microsoft/TypeScript/wiki/Coding-guidelines">TypeScript coding guidelines</a>
do not recommend using &ldquo;I&rdquo; as a prefix for interface names. So I need to hold my C# reflexes.</p>

<p>There are more than a few things that one has to do in order to make the TypeScript compiler happy. For anyone
with a &ldquo;Javascript mindset&rdquo; this may feel like unnecessary burden. But once you make this investment,
the amount of help and insight you get from the TypeScript compiler and tooling around it is amazing.</p>

<p>Thanks for reading.</p>

<p>~ Hakan</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2017 - Hakan Tuncer <br/><br/>
  Disclaimer: The opinions expressed herein are my own personal opinions and do not represent my employer’s view in any way.
</p>
</footer>
			

<script type="text/javascript">
      var disqus_shortname = 'hakantuncer';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





		</div>
	</div>
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48149810-1', 'hakantuncer.com');
  ga('send', 'pageview');

</script>
</body>
</html>
